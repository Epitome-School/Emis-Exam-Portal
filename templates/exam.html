{% extends "base.html" %}

{% block title %}Exam - EMIS Exam Portal{% endblock %}

{% block styles %}
<!-- Subject injected dynamically -->
<meta name="exam-subject" content="{{ subject|default('exam') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/exam_gen.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/exam_spec.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/hour-glass.css') }}">
{% endblock %}


{% block header_actions %}
<div class="flex items-center space-x-6">
  <!-- Countdown Timer -->
  <div id="examTimer" class="exam-timer-ui {% if not exam_started %}hidden{% endif %}">
    <i class="fas fa-clock timer-icon"></i>
    <span id="timerDisplay" class="timer-digits">20:00</span>
  </div>

  <!-- Fullscreen Toggle -->
  <button id="fullscreenBtn" class="icon-btn {% if not exam_started %}hidden{% endif %}" title="Toggle fullscreen">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 8V4h4M20 8V4h-4M4 16v4h4M20 16v4h-4" />
    </svg>
  </button>
</div>

{% endblock %}

{% block content %}

<!-- Instructions Modal -->
<div id="instructionsModal" class="modal-backdrop {% if exam_started %}hidden{% endif %}">
  <div class="modal-card">
    <a href="{{ url_for('user_portal') }}" class="close-x" aria-label="Close">‚úï</a>
<header class="modal-head">
  <h2 class="text-xl font-bold">
    üìã EXAM INSTRUCTIONS:
    <br>
    <span class="text-gray-600 font-medium">Read all instructions carefully</span>
  </h2>
  <div class="exam-duration-badge">
    <i class="fas fa-clock"></i> 20 minutes
  </div>
</header>


    <div class="modal-body instructions-body">
      <div class="instruction-card">
        <span class="instr-icon">üìò</span>
        <p>This exam contains <b>40 multiple-choice questions (MCQs)</b>.</p>
      </div>

   <div class="instruction-card">
        <span class="instr-icon">üö©</span>
        <p>You can only <b>answer a question once.</b> Ensure to check questions carefully before answering.</p>
      </div>

      <div class="instruction-card">
        <span class="instr-icon">üî¢</span>
        <p>Each question has options <b>A‚ÄìD</b>. Select the most appropriate answer.</p>
      </div>

      <div class="instruction-card">
        <span class="instr-icon">‚è≥</span>
        <p>You have <b>20 minutes</b> to complete all questions.</p>
      </div>

      <div class="instruction-card">
        <span class="instr-icon">‚û°Ô∏è</span>
        <p>Navigate using the <b>Previous</b> and <b>Next</b> buttons or the question grid.</p>
      </div>

      <div class="instruction-card">
        <span class="instr-icon">üö©</span>
        <p>You may <b>flag questions</b> to review them before submission.</p>
      </div>

      <div class="instruction-card">
        <span class="instr-icon">‚ö†Ô∏è</span>
        <p>Once started, you must finish in one sitting.</p>
      </div>
    </div>

    <footer class="modal-foot">
      <a href="{{ url_for('user_portal') }}" class="btn-secondary">Back to Dashboard</a>
      <button id="startExamBtn" class="btn-primary">üöÄ Start Exam</button>
    </footer>
  </div>
</div>


<!-- Main -->
<div id="examInterface" class="{% if not exam_started %}hidden{% endif %} exam-shell">

  <!-- Left sidebar -->
  <aside class="exam-sidebar" role="navigation" aria-label="Exam navigation">
    <div class="sidebar-top">
      <div class="progress-overview">
        <div class="counts">
          <div class="count-block">
            <div id="answeredCount" class="count-num">0</div>
            <div class="count-label">Answered</div>
          </div>
          <div class="count-block">
            <div id="flaggedCount" class="count-num">0</div>
            <div class="count-label">Flagged</div>
          </div>
          <div class="count-block">
            <div id="remainingCount" class="count-num">0</div>
            <div class="count-label">Remaining</div>
          </div>
        </div>

        <div class="progress-line" aria-hidden="true">
          <div id="progressBar" class="progress-fill" style="width:0%"></div>
        </div>
        <div class="progress-text" id="progressText">0% Complete</div>
      </div>
    </div>

    <div class="sidebar-middle">
      <h4 class="nav-title">Question Navigation</h4>

      <div id="questionGridWrap">
        <div id="questionGrid" class="question-grid" aria-label="Question navigation"></div>
      </div>

      <div class="nav-action-row">
        <button onclick="showSummary()" class="btn-secondary small w-full">Review Summary</button>
        <button onclick="endExam()" class="btn-danger small w-full">End Exam</button>
      </div>
    </div>

    <div class="sidebar-bottom muted small muted-note">
      <div>Tip: use <kbd>‚Üê</kbd> and <kbd>‚Üí</kbd> for navigation</div>
    </div>
  </aside>

  <!-- Main question area -->
  <main class="exam-main" role="main">
    <div class="question-header">
      <div>
        <h2 class="q-h2">Question <span id="currentQuestionNumber">1</span> <small> / <span id="totalQuestions">0</span></small></h2>
        <p class="muted">Choose the best answer</p>
      </div>

      <div class="question-controls">
        <button id="flagBtn" onclick="toggleFlag()" class="flag-btn" title="Flag question (F)">
          <svg id="flagIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h14l-3 4 3 4H4z"/></svg>
          <span id="flagText">Flag</span>
        </button>
      </div>
    </div>

    <section class="question-stage" aria-live="polite">
      <div id="questionSlider" class="question-slider">
        <article class="question-card" id="questionCard" tabindex="0">
          <div class="question-body">
            <div id="questionContent" class="question-text" aria-atomic="true"></div>
            <ul id="answerList" class="answers-list" role="list"></ul>
          </div>

          <div class="question-foot">
            <div class="nav-left">
              <button id="prevBtn" onclick="previousQuestion()" disabled class="btn-ghost">‚Üê Previous</button>
            </div>
            <div class="nav-center muted">Press <kbd>F</kbd> to flag</div>
            <div class="nav-right">
              <button id="nextBtn" onclick="nextQuestion()" class="btn-primary">Next ‚Üí</button>
            </div>
          </div>
        </article>
      </div>
    </section>
  </main>
</div>

<!-- Summary Modal -->
<div id="summaryModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal-card small">
    <div class="modal-head">
      <h2>Exam Summary</h2>
      <button onclick="closeSummary()" class="close-x" aria-label="Close">‚úï</button>
    </div>
    <div id="summaryContent" class="modal-body"></div>
    <div class="modal-foot">
      <button onclick="closeSummary()" class="btn-secondary">Continue Exam</button>
      <button onclick="submitExam()" class="btn-success">Submit Exam</button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden" aria-hidden="true">
  <div class="loader-card">
    <div class="spinner" aria-hidden="true"></div>
    <span>Loading exam...</span>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/exam-core.js') }}"></script>
<script src="{{ url_for('static', filename='js/exam-features.js') }}"></script>
<script src="{{ url_for('static', filename='js/exam-realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/hour-glass.js') }}"></script>
<script>console.log("‚úÖ updated exam.html loaded")</script>
{% endblock %}
